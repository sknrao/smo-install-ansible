# Pre-configuration tasks before SMO deployment

- name: Create additional required namespaces
  shell: |
    {{ kubectl_command }} create namespace {{ item }} || true
  loop:
    - network
    - network-simulators  
  register: ns_create
  changed_when: "'created' in ns_create.stdout"
  tags: preconfigure

- name: Create service accounts
  block:
    - name: Create ONAP service account
      shell: |
        {{ kubectl_command }} create serviceaccount onap-sa -n {{ onap_namespace }} || true
      register: onap_sa
      changed_when: "'created' in onap_sa.stdout"
      tags: preconfigure

    - name: Create NonRTRIC service account
      shell: |
        {{ kubectl_command }} create serviceaccount nonrtric-sa -n {{ onap_namespace }} || true
      register: nonrtric_sa
      changed_when: "'created' in nonrtric_sa.stdout"
      tags: preconfigure

  when: create_service_accounts
  tags: preconfigure

- name: Setup RBAC
  block:
    - name: Create cluster role for SMO components
      shell: |
        cat <<EOF | {{ kubectl_command }} apply -f -
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRole
        metadata:
          name: smo-cluster-role
        rules:
        - apiGroups: [""]
          resources: ["pods", "services", "endpoints", "configmaps", "secrets"]
          verbs: ["get", "list", "watch", "create", "update", "patch"]
        - apiGroups: ["apps"]
          resources: ["deployments", "statefulsets"]
          verbs: ["get", "list", "watch"]
        EOF
      register: cluster_role
      changed_when: "'created' in cluster_role.stdout or 'configured' in cluster_role.stdout"
      tags: preconfigure

    - name: Bind cluster role to service accounts
      shell: |
        {{ kubectl_command }} create clusterrolebinding smo-{{ item }}-binding \
          --clusterrole=smo-cluster-role \
          --serviceaccount={{ onap_namespace }}:{{ item }} || true
      loop:
        - onap-sa
        - nonrtric-sa
      register: role_binding
      changed_when: "'created' in role_binding.stdout"
      tags: preconfigure

  when: create_rbac
  tags: preconfigure

- name: Setup secrets
  block:
    - name: Create ONAP credentials secret
      shell: |
        {{ kubectl_command }} create secret generic onap-credentials \
          -n {{ onap_namespace }} \
          --from-literal=admin-password='{{ onap_admin_password }}' \
          --from-literal=db-root-password='{{ onap_db_root_password }}' \
          --from-literal=db-password='{{ onap_db_password }}' \
          --dry-run=client -o yaml | {{ kubectl_command }} apply -f -
      register: onap_secret
      changed_when: "'created' in onap_secret.stdout or 'configured' in onap_secret.stdout"
      tags: preconfigure

    - name: Create NonRTRIC credentials secret (if needed)
      shell: |
        {{ kubectl_command }} create secret generic nonrtric-credentials \
          -n {{ onap_namespace }} \
          --from-literal=admin-password='{{ onap_admin_password }}' \
          --dry-run=client -o yaml | {{ kubectl_command }} apply -f -
      register: nonrtric_secret
      changed_when: "'created' in nonrtric_secret.stdout or 'configured' in nonrtric_secret.stdout"
      tags: preconfigure

  when: setup_secrets
  tags: preconfigure

- name: Check if jq is installed
  command: which jq
  register: jq_check
  changed_when: false
  failed_when: false

- name: Install jq if not present
  block:
    - name: Display jq installation message
      debug:
        msg: "jq is not installed. Installing jq..."

    - name: Download jq binary
      get_url:
        url: "https://github.com/jqlang/jq/releases/download/jq-1.8.1/jq-linux-{{ jq_arch }}"
        dest: /usr/local/bin/jq
        mode: '0755'
      become: yes

  when: jq_check.rc != 0

- name: Set variables for SMO configuration
  set_fact:
    nexus_proxy_docker_io_repo: "nexus3.o-ran-sc.org:10001"
    smo_sc_yaml_path: "{{ smo_storage_class_yaml | default('../packages/pre-configuration/smo-sc.yaml') }}"

- name: Add OpenEBS Helm repository
  kubernetes.core.helm_repository:
    name: openebs
    repo_url: https://openebs.github.io/openebs

- name: Install OpenEBS (non-blocking)
  kubernetes.core.helm:
    name: openebs
    chart_ref: openebs/openebs
    chart_version: "4.3.0"
    release_namespace: openebs
    create_namespace: yes
    values:
      engines:
        replicated:
          mayastor:
            enabled: false
        local:
          lvm:
            enabled: false
          zfs:
            enabled: false
      loki:
        enabled: false
      alloy:
        enabled: false
      global:
        imageRegistry: "{{ nexus_proxy_docker_io_repo }}"
      preUpgradeHook:
        image:
          registry: "{{ nexus_proxy_docker_io_repo }}"
          repo: bitnamilegacy/kubectl
    wait: no
  register: openebs_install

- name: Create storage class for SMO
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        annotations:
          cas.openebs.io/config: |
            - name: StorageType
              value: "hostpath"
            - name: BasePath
              value: "/dockerdata/smo"
          openebs.io/cas-type: local
        name: smo-storage
      provisioner: openebs.io/local
      reclaimPolicy: Delete
      volumeBindingMode: WaitForFirstConsumer

- name: MariaDB operator installation block
  block:
    - name: Display MariaDB installation message
      debug:
        msg: "Installing MariaDB operator..."

    - name: Create mariadb-operator namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: mariadb-operator

    - name: Add MariaDB operator Helm repository
      kubernetes.core.helm_repository:
        name: mariadb-operator
        repo_url: https://helm.mariadb.com/mariadb-operator

    - name: Install MariaDB operator CRDs (non-blocking)
      kubernetes.core.helm:
        name: mariadb-operator-crds
        chart_ref: mariadb-operator/mariadb-operator-crds
        release_namespace: mariadb-operator
        wait: no
      register: mariadb_crds_install
      when: not onap_successful

    - name: Install MariaDB operator (non-blocking)
      kubernetes.core.helm:
        name: mariadb-operator
        chart_ref: mariadb-operator/mariadb-operator
        release_namespace: mariadb-operator
        wait: no
      register: mariadb_operator_install
      when: not onap_successful

- name: Wait for OpenEBS installation to complete
  async_status:
    jid: "{{ openebs_install.ansible_job_id }}"
  register: openebs_job_result
  until: openebs_job_result.finished
  retries: 60
  delay: 10
  when: openebs_install.ansible_job_id is defined

- name: Wait for MariaDB CRDs installation to complete
  async_status:
    jid: "{{ mariadb_crds_install.ansible_job_id }}"
  register: mariadb_crds_job_result
  until: mariadb_crds_job_result.finished
  retries: 60
  delay: 10
  when: 
    - install_mariadb is defined
    - install_mariadb == "true"
    - mariadb_crds_install.ansible_job_id is defined

- name: Wait for MariaDB operator installation to complete
  async_status:
    jid: "{{ mariadb_operator_install.ansible_job_id }}"
  register: mariadb_operator_job_result
  until: mariadb_operator_job_result.finished
  retries: 60
  delay: 10
  when: 
    - install_mariadb is defined
    - install_mariadb == "true"
    - mariadb_operator_install.ansible_job_id is defined

- name: Display completion message
  debug:
    msg:
      - "================================================================================"
      - "                SMO Preconfiguration Completed                                 "
      - "================================================================================"

- name: Configure persistent storage
  block:
    - name: Create PVC for ONAP data (if needed)
      shell: |
        cat <<EOF | {{ kubectl_command }} apply -f -
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: onap-data-pvc
          namespace: {{ onap_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: {{ storage_class | default("standard") }}
        EOF
      register: pvc_create
      changed_when: "'created' in pvc_create.stdout or 'configured' in pvc_create.stdout"
      failed_when: false
      tags: preconfigure

  when: configure_persistent_storage
  tags: preconfigure
