---
# File: process_nonrtric_secret.yml
# Called with loop_var: nonrtric_secret_index

- name: Read secret name from override YAML
  command: >
    yq '.nonrtric.secrets[{{ nonrtric_secret_index }}].name' {{ effective_nonrtric_override }}
  register: n_secret_name
  changed_when: false

- name: Read dependsOn field from override YAML
  command: >
    yq '.nonrtric.secrets[{{ nonrtric_secret_index }}].dependsOn' {{ effective_nonrtric_override }}
  register: n_depends_on
  changed_when: false

- name: Check if dependsOn is enabled
  command: >
    yq '.{{ n_depends_on.stdout | trim }}' {{ effective_nonrtric_override }}
  register: n_depends_on_value
  changed_when: false

- name: Skip secret copy if dependsOn is not true
  debug:
    msg: "{{ n_depends_on.stdout | trim }} is not set to true. Skipping {{ n_secret_name.stdout | trim }} copy..."
  when: n_depends_on_value.stdout | trim != "true"

- name: Display copy progress
  debug:
    msg: "Copying {{ n_secret_name.stdout | trim }} from onap namespace to smo namespace..."
  when: n_depends_on_value.stdout | trim == "true"

- name: Wait for secret to exist in onap namespace
  command: kubectl get secret {{ n_secret_name.stdout | trim }} -n onap
  register: n_secret_check
  retries: 60
  delay: 10
  until: n_secret_check.rc == 0
  failed_when: n_secret_check.rc != 0
  when: n_depends_on_value.stdout | trim == "true"

- name: Display secret found message
  debug:
    msg: "Secret {{ n_secret_name.stdout | trim }} found in onap namespace"
  when: 
    - n_depends_on_value.stdout | trim == "true"
    - n_secret_check.rc == 0

- name: Copy secret from onap to nonrtric namespace
  shell: |
    kubectl get secret {{ n_secret_name.stdout | trim }} -n onap -o json \
    | jq 'del(.metadata["namespace","creationTimestamp","resourceVersion","selfLink","uid","ownerReferences"])' \
    | kubectl apply -n nonrtric -f -
  register: n_secret_copy
  when: n_depends_on_value.stdout | trim == "true"
  changed_when: "'created' in n_secret_copy.stdout or 'configured' in n_secret_copy.stdout"

- name: Display secret copy result
  debug:
    msg: "Secret {{ n_secret_name.stdout | trim }} copied successfully to smo namespace"
  when: 
    - n_depends_on_value.stdout | trim == "true"
    - n_secret_copy is defined
    - n_secret_copy.rc == 0
