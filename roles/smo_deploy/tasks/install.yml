---
# SMO installation tasks

- name: Setup post-renderer if enabled
  block:
    - name: Create post-renderer script directory
      file:
        path: "{{ post_renderer_script | dirname }}"
        state: directory
        mode: '0755'
      tags: install

    - name: Install yq if not present (required for post-renderer)
      block:
        - name: Check if yq is installed
          command: which yq
          register: yq_check
          failed_when: false
          changed_when: false

        - name: Download and install yq
          shell: |
            YQ_VERSION="v4.35.1"
            wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
            chmod +x /usr/local/bin/yq
          when: yq_check.rc != 0

        - name: Verify yq installation
          command: yq --version
          register: yq_version
          changed_when: false

        - name: Display yq version
          debug:
            msg: "yq installed: {{ yq_version.stdout }}"

      tags: install

    - name: Copy post-renderer script
      copy:
        src: helm-post-renderer.sh
        dest: "{{ post_renderer_script }}"
        mode: '0755'
      tags: install

    - name: Read image mappings from external file
      block:
        - name: Check if external mappings file exists
          stat:
            path: "{{ image_mappings_file }}"
          register: mappings_file_stat

        - name: Fail if file specified but doesn't exist
          fail:
            msg: "Image mappings file specified but not found: {{ image_mappings_file }}"
          when: not mappings_file_stat.stat.exists

        - name: Read mappings from file
          slurp:
            src: "{{ image_mappings_file }}"
          register: mappings_content
          when: mappings_file_stat.stat.exists

        - name: Parse mappings from file
          set_fact:
            file_based_mappings: "{{ (mappings_content.content | b64decode).split('\n') | select('match', '^[^#].*') | select() | list }}"
          when: mappings_file_stat.stat.exists

        - name: Display file-based mappings count
          debug:
            msg: "Loaded {{ file_based_mappings | length }} mappings from file: {{ image_mappings_file }}"
          when: mappings_file_stat.stat.exists

      when: image_mappings_file != ""
      tags: install

    - name: Combine inline and file-based mappings
      set_fact:
        effective_image_mappings: "{{ image_tag_mappings + (file_based_mappings | default([])) }}"
      when: image_mappings_file != ""
      tags: install

    - name: Use inline mappings only
      set_fact:
        effective_image_mappings: "{{ image_tag_mappings }}"
      when: image_mappings_file == ""
      tags: install

    - name: Generate post-renderer configuration
      template:
        src: post-renderer-config.yaml.j2
        dest: "{{ post_renderer_config }}"
        mode: '0644'
      tags: install

    - name: Display post-renderer configuration summary
      debug:
        msg:
          - "=========================================="
          - "Post-Renderer Configuration"
          - "=========================================="
          - "Script: {{ post_renderer_script }}"
          - "Config: {{ post_renderer_config }}"
          - "Total mappings: {{ effective_image_mappings | default([]) | length }}"
          - "  - Inline mappings: {{ image_tag_mappings | length }}"
          - "  - File mappings: {{ file_based_mappings | default([]) | length }}"
          - "Using yq: {{ yq_version.stdout | default('not available') }}"
          - "=========================================="
      tags: install

  when: enable_post_renderer
  tags: 
    - install
    - post-renderer


- name: Set Helm repository based on mode
  set_fact:
    helm_repo: >-
      {% if deployment_mode == 'dev' %}local
      {% elif deployment_mode == 'snapshot' %}oran-snapshot
      {% else %}oran-release{% endif %}
  tags: install


- name: Determine override files based on flavor and custom settings
  set_fact:
    effective_onap_override: "{{ custom_onap_override if custom_onap_override != '' else (it_dep_dir + '/smo-install/' + onap_override_file) }}"
    effective_nonrtric_override: "{{ custom_nonrtric_override if custom_nonrtric_override != '' else (it_dep_dir + '/smo-install/' + nonrtric_override_file) }}"
    effective_simulators_override: "{{ custom_simulators_override if custom_simulators_override != '' else (it_dep_dir + '/smo-install/' + simulators_override_file) }}"
  tags: install

- name: Check if flavor override files exist
  stat:
    path: "{{ item }}"
  register: override_files_check
  loop:
    - "{{ effective_onap_override }}"
    - "{{ effective_nonrtric_override }}"
  when: deploy_onap or deploy_nonrtric
  tags: install

- name: Display override file status
  debug:
    msg:
      - "Deployment Configuration:"
      - "Flavor: {{ deployment_flavor }}"
      - "Mode: {{ deployment_mode }}"
      - "ONAP Override: {{ effective_onap_override }}"
      - "Non-RT RIC Override: {{ effective_nonrtric_override }}"
      - "Using ChartMuseum: {{ use_chartmuseum }}"
      - "Post-Renderer: {{ enable_post_renderer }}"
  tags: install

- name: Warn if override files are missing
  debug:
    msg: "WARNING: Override file {{ item.item }} not found. Using default values."
  loop: "{{ override_files_check.results }}"
  when: 
    - override_files_check.results is defined
    - not item.stat.exists
  tags: install

- name: Check if SMO is already deployed
  shell: |
    {{ kubectl_command }} get deployment -n {{ onap_namespace }} | grep -i onap || true
  register: smo_deployed
  changed_when: false
  tags: install

- name: Uninstall existing SMO if force reinstall is enabled
  block:
    - name: Remove existing Helm releases
      shell: |
        for release in $(helm list -n {{ onap_namespace }} -q); do
          helm uninstall $release -n {{ onap_namespace }}
        done
      tags: install

    - name: Wait for pods to terminate
      shell: |
        {{ kubectl_command }} wait --for=delete pods --all -n {{ onap_namespace }} --timeout=600s || true
      tags: install

  when: force_reinstall and smo_deployed.stdout != ""

- name: Set Helm repository based on mode
  set_fact:
    helm_repo_suffix: "{{ '-staging' if deployment_mode == 'snapshot' else '' }}"
  tags: install

- name: Read strimzi.enabled from override YAML
  command: >
    yq e '.strimzi.enabled' {{ onap_override_file }}
  register: strimzi_enabled
  changed_when: false
  failed_when:
    - strimzi_enabled.rc != 0
    - strimzi_enabled.stdout | length == 0

- name: Set INSTALL_STRIMZI fact
  set_fact:
    install_strimzi: "{{ strimzi_enabled.stdout | trim }}"

- name: Determine Strimzi Helm repo
  set_fact:
    strimzi_helm_repo: >-
      {{ 'local' if helm_repo == 'local' else 'strimzi' }}
  when: install_strimzi == 'true'

- name: Install Strimzi Kafka Operator
  command: >
    helm upgrade --install strimzi-kafka-operator
    strimzi/strimzi-kafka-operator
    --namespace strimzi-system
    --version 0.45.0
    --set watchAnyNamespace=true
    --create-namespace
  when: install_strimzi == 'true'

- name: Deploy ONAP components
  shell: |
    helm deploy --debug {{ onap_namespace }} {{ helm_repo }}/onap \
      --namespace {{ onap_namespace }} \
      --create-namespace \
      {% if override_files_check.results[0].stat.exists %}
      -f {{ effective_onap_override }} \
      {% endif %}
      --set global.flavor={{ deployment_flavor }} \
      {% if enable_post_renderer %}
      --post-renderer {{ post_renderer_script }} \
      {% endif %}
      --timeout {{ helm_timeout }}s
  args:
    chdir: "{{ it_dep_dir }}/smo-install"
  environment:
    POST_RENDERER_CONFIG: "{{ post_renderer_config }}"
  when: deploy_onap
  register: onap_install
  failed_when: onap_install.rc != 0 and not cleanup_on_failure
  tags: install

- name: Wait for ONAP deployments to stabilize
  pause:
    seconds: 300
  when: deploy_onap and onap_install.rc == 0
  tags: install

- name: Deploy Non-RT RIC
  shell: |
    helm upgrade --install oran-nonrtric {{ helm_repo }}/nonrtric \
      --namespace {{ nonrtric_namespace }} \
      {% if override_files_check.results[1].stat.exists %}
      -f {{ effective_nonrtric_override }} \
      {% endif %}
      --set nonrtric.persistence.mountPath="/dockerdata-nfs/deployment-{{ ansible_date_time.epoch }}" \
      {% if enable_post_renderer %}
      --post-renderer {{ post_renderer_script }} \
      {% endif %}
      --timeout {{ helm_timeout }}s \
      --wait
  args:
    chdir: "{{ it_dep_dir }}/smo-install"
  environment:
    POST_RENDERER_CONFIG: "{{ post_renderer_config }}"
  when: deploy_nonrtric
  register: nonrtric_install
  failed_when: nonrtric_install.rc != 0 and not cleanup_on_failure
  tags: install

- name: Wait for Kong deployment to be ready
  command: >
    kubectl wait --for=condition=available 
    deployment/oran-nonrtric-kong 
    -n {{ nonrtric_namespace }} 
    --timeout=15m
  when: deploy_nonrtric and nonrtric_install.rc == 0
  tags: install

- name: Deploy Network Simulators (optional)
  block:
    - name: Check if simulators override file exists
      stat:
        path: "{{ effective_simulators_override }}"
      register: simulators_override_check
      tags: install

    - name: Wait for ONAP and Non-RT RIC to be ready before deploying simulators
      shell: |
        {{ kubectl_command }} wait --for=condition=Ready pods --all -n {{ onap_namespace }} --timeout={{ pod_ready_timeout }}s
      retries: 2
      delay: 30
      tags: install

    - name: Deploy DU/RU Simulators
      shell: |
        {% if use_chartmuseum %}
        helm install network-simulators local/network-simulators \
        {% else %}
        helm install network-simulators oran/network-simulators{{ helm_repo_suffix }} \
        {% endif %}
          --namespace network \
          --create-namespace \
          {% if simulators_override_check.stat.exists %}
          --values {{ effective_simulators_override }} \
          {% endif %}
          {% if enable_post_renderer %}
          --post-renderer {{ post_renderer_script }} \
          {% endif %}
          --timeout {{ helm_timeout }}s \
          --wait
      args:
        chdir: "{{ it_dep_dir }}/smo-install"
      environment:
        POST_RENDERER_CONFIG: "{{ post_renderer_config }}"
      register: simulators_install
      failed_when: simulators_install.rc != 0 and not cleanup_on_failure
      tags: install

  when: deploy_oran_components and (deploy_onap or deploy_nonrtric)
  tags: 
    - install
    - simulators

- name: Ensure SMO namespace exists
  command: kubectl create namespace smo
  register: smo_ns
  failed_when:
    - smo_ns.rc != 0
    - "'AlreadyExists' not in smo_ns.stderr"
  changed_when:
    - "'created' in smo_ns.stdout"

- name: Install ORAN SMO via Helm
  shell: |
    helm upgrade --install oran-smo {{ helm_repo }}/smo \
      --namespace smo \
      -f {{ effective_nonrtric_override }} \
      {% if enable_post_renderer %}
      --post-renderer {{ post_renderer_script }} \
      {% endif %}
      --timeout 15m
  args:
    chdir: "{{ it_dep_dir }}/smo-install"
  environment:
    POST_RENDERER_CONFIG: "{{ post_renderer_config }}"
  when: deploy_smo
  register: smo_install
  failed_when: smo_install.rc != 0 and not cleanup_on_failure
  tags: install

- name: Get number of SMO secrets defined in override YAML
  command: >
    yq '.smo.secrets | length' {{ onap_override_file }}
  register: smo_secrets_size
  changed_when: false
  failed_when: smo_secrets_size.rc != 0

- name: Exit early if no secrets to copy
  meta: end_play
  when: smo_secrets_size.stdout | int == 0

- name: Build SMO secrets list
  set_fact:
    smo_secrets_indexes: "{{ range(0, smo_secrets_size.stdout | int) | list }}"

- name: Process SMO secrets
  include_tasks: process_smo_secret.yml
  loop: "{{ smo_secrets_indexes }}"
  loop_control:
    loop_var: smo_secret_index


- name: Wait for all pods to be ready
  shell: |
    {{ kubectl_command }} wait --for=condition=Ready pods --all -n {{ onap_namespace }} --timeout={{ pod_ready_timeout }}s
  register: pods_ready
  retries: 3
  delay: 60
  until: pods_ready.rc == 0
  failed_when: pods_ready.rc != 0 and not cleanup_on_failure
  tags: install

- name: Get all pods status
  shell: |
    {{ kubectl_command }} get pods -n {{ onap_namespace }}
  register: pods_status
  changed_when: false
  tags: install

- name: Display pods status
  debug:
    var: pods_status.stdout_lines
  tags: install

- name: Get all services
  shell: |
    {{ kubectl_command }} get services -n {{ onap_namespace }}
  register: services_status
  changed_when: false
  tags: install

- name: Display services
  debug:
    var: services_status.stdout_lines
  tags: install

- name: Cleanup on failure
  block:
    - name: Remove failed deployments
      shell: |
        helm list -n {{ onap_namespace }} -q | xargs -r helm uninstall -n {{ onap_namespace }}
      tags: install

    - name: Delete namespace
      shell: |
        {{ kubectl_command }} delete namespace {{ onap_namespace }} --grace-period=0 --force || true
      tags: install

  when: cleanup_on_failure and (onap_install.failed | default(false) or nonrtric_install.failed | default(false))
