---
# File: process_smo_secret.yml
# Called with loop_var: smo_secret_index

- name: Read secret name from override YAML
  command: >
    yq '.smo.secrets[{{ smo_secret_index }}].name' {{ effective_nonrtric_override }}
  register: secret_name
  changed_when: false

- name: Read dependsOn field from override YAML
  command: >
    yq '.smo.secrets[{{ smo_secret_index }}].dependsOn' {{ effective_nonrtric_override }}
  register: depends_on
  changed_when: false

- name: Check if dependsOn is enabled
  command: >
    yq '.{{ depends_on.stdout | trim }}' {{ effective_nonrtric_override }}
  register: depends_on_value
  changed_when: false

- name: Skip secret copy if dependsOn is not true
  debug:
    msg: "{{ depends_on.stdout | trim }} is not set to true. Skipping {{ secret_name.stdout | trim }} copy..."
  when: depends_on_value.stdout | trim != "true"

- name: Display copy progress
  debug:
    msg: "Copying {{ secret_name.stdout | trim }} from onap namespace to smo namespace..."
  when: depends_on_value.stdout | trim == "true"

- name: Check if secret exists in onap namespace
  command: kubectl get secret {{ secret_name.stdout | trim }} -n onap
  register: secret_exists_check
  failed_when: false  # Don't fail if secret doesn't exist
  changed_when: false
  when: depends_on_value.stdout | trim == "true"

- name: Wait for secret to exist in onap namespace
  command: kubectl get secret {{ secret_name.stdout | trim }} -n onap
  register: secret_check
  retries: 60
  delay: 10
  until: secret_check.rc == 0
  failed_when: false  # Don't fail the playbook
  when: 
    - depends_on_value.stdout | trim == "true"
    - secret_exists_check.rc == 0 or allow_secret_wait | default(true)
  tags: secrets

- name: Warn if secret not found
  debug:
    msg: "WARNING: Secret {{ secret_name.stdout | trim }} not found in onap namespace after waiting. Skipping copy."
  when:
    - depends_on_value.stdout | trim == "true"
    - secret_check is defined
    - secret_check.rc != 0

- name: Copy secret from onap to smo namespace
  shell: |
    kubectl get secret {{ secret_name.stdout | trim }} -n onap -o json \
    | jq 'del(.metadata["namespace","creationTimestamp","resourceVersion","selfLink","uid","ownerReferences"])' \
    | kubectl apply -n smo -f -
  register: secret_copy
  when:
    - depends_on_value.stdout | trim == "true"
    - secret_check is defined
    - secret_check.rc == 0
  changed_when: "'created' in secret_copy.stdout or 'configured' in secret_copy.stdout"
  tags: secrets

- name: Display secret copy result
  debug:
    msg: "Secret {{ secret_name.stdout | trim }} copied successfully to smo namespace"
  when: 
    - depends_on_value.stdout | trim == "true"
    - secret_copy is defined
    - secret_copy.rc is defined
    - secret_copy.rc == 0
